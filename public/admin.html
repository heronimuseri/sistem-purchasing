<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Purchasing System</title>
  <link rel="stylesheet" href="/css/all.min.css" type="text/css" />
  <link rel="stylesheet" href="/css/admin.css?v=1.0.2" />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SPA PR">
</head>

<body>
  <div class="admin-container">
    <nav class="sidebar">
      <div class="sidebar-header">
        <h3>Admin Panel</h3>
        <span id="admin-name">Admin User</span>
      </div>
      <ul class="sidebar-nav">
        <li>
          <a href="#" class="nav-link" data-target="content-user"><i class="fa-solid fa-users-gear"></i> Master User</a>
        </li>
        <li>
          <a href="#" class="nav-link" data-target="content-vendor"><i class="fa-solid fa-store"></i> Master Vendor</a>
        </li>
        <li>
          <a href="#" class="nav-link" data-target="content-material"><i class="fa-solid fa-boxes-stacked"></i> Master
            Material</a>
        </li>
        <li>
          <a href="#" class="nav-link" data-target="content-database"><i class="fa-solid fa-database"></i> Database</a>
        </li>
        <li>
          <a href="#" class="nav-link" data-target="content-settings"><i class="fa-solid fa-gears"></i> Pengaturan</a>
        </li>
        <li>
          <a href="#" id="logout-btn" class="nav-link"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </li>
      </ul>
    </nav>

    <main class="main-content">
      <section id="content-main" class="content-section">
        <div class="content-header">
          <h1>Selamat Datang di Panel Admin</h1>
        </div>
        <p>
          Silakan pilih menu di samping untuk mulai mengelola data sistem.
        </p>
      </section>

      <section id="content-user" class="content-section hidden">
        <div class="content-header">
          <h1>Master User & Konfigurasi WA</h1>
        </div>
        <p>
          Kelola data user, role (Kerani, KTU, EM), dan nomor WhatsApp (WA)
          untuk notifikasi approval.
        </p>

        <div class="content-container">
          <div class="user-layout">
            <div class="user-form-wrapper">
              <div class="card">
                <h2 id="user-form-title">Tambah User Baru</h2>
                <form id="form-user">
                  <input type="hidden" id="user-id" />
                  <input type="hidden" id="user-company-hidden" />

                  <div class="form-group">
                    <label for="user-name">Nama Lengkap</label>
                    <input type="text" id="user-name" required placeholder="Masukkan nama user" />
                  </div>

                  <div class="form-group">
                    <label for="user-company">Perusahaan (Company ID)</label>
                    <select id="user-company" required>
                      <option value="">Pilih Perusahaan</option>
                      <option value="SPA_70">SPA_70</option>
                      <option value="SNA_70">SNA_70</option>
                      <option value="PT SPA">PT SPA</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="user-username">Username</label>
                    <input type="text" id="user-username" required placeholder="Masukkan username user" />
                  </div>

                  <div class="form-group">
                    <label for="user-password">Password</label>
                    <input type="password" id="user-password" required placeholder="Isi jika tambah baru" />
                    <small>Wajib diisi saat Tambah User. Untuk Edit, gunakan tombol
                      'Pass' di tabel.</small>
                  </div>

                  <div class="form-group">
                    <label for="user-role">Role Approval</label>
                    <select id="user-role" required>
                      <option value="">Pilih Role</option>
                      <option value="kerani">kerani</option>
                      <option value="ktu">ktu</option>
                      <option value="manager">manager</option>
                      <option value="admin">admin</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="user-wa">Nomor WhatsApp</label>
                    <input type="tel" id="user-wa" required placeholder="Contoh: 6281234567890" />
                    <small>Gunakan format internasional (62) tanpa tanda + atau 0
                      di depan.</small>
                  </div>
                  <div class="form-group">
                    <button type="submit" class="btn btn-primary" id="btn-save-user">
                      Simpan User
                    </button>
                    <button type="button" class="btn btn-secondary" id="btn-cancel-edit" style="display: none">
                      Batal
                    </button>
                  </div>
                </form>
                <div id="user-notification" class="notification"></div>
              </div>

              <div class="card">
                <h2>Konfigurasi Grup WA Posting</h2>
                <p>
                  Atur ID/Nomor Grup WA untuk notifikasi otomatis setelah
                  approval final (manager).
                </p>
                <form id="form-group-wa">
                  <div class="form-group">
                    <label for="group-wa-id">ID/Nomor Grup WA</label>
                    <input type="text" id="group-wa-id" required placeholder="Masukkan ID Grup WA" />
                  </div>
                  <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                      Simpan Konfigurasi
                    </button>
                  </div>
                </form>
                <div id="group-wa-notification" class="notification"></div>
              </div>

              <!-- Konfigurasi Notifikasi Umum -->
              <div class="card">
                <h2>Pengaturan Notifikasi</h2>
                <p>Aktifkan atau nonaktifkan pengiriman notifikasi WhatsApp secara global.</p>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                  <label class="switch">
                    <input type="checkbox" id="toggle-wa-notifications">
                    <span class="slider round"></span>
                  </label>
                  <span id="wa-notification-status-text">Notifikasi Aktif</span>
                </div>
              </div>
            </div>

            <div class="user-list-wrapper">
              <div class="card">
                <h2>Daftar User</h2>
                <div class="table-responsive">
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Nama</th>
                        <th>Perusahaan</th>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Nomor WA</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="user-table-body"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
      </section>

      <section id="content-vendor" class="content-section hidden">
        <div class="content-header">
          <h1><i class="fa-solid fa-store"></i> Master Vendor</h1>
        </div>
        <p>Kelola data vendor/supplier untuk pembelian material.</p>

        <div class="content-container">
          <div class="user-layout">
            <!-- Form Vendor -->
            <div class="user-form-wrapper">
              <div class="card">
                <h2 id="vendor-form-title">Tambah Vendor Baru</h2>
                <form id="form-vendor">
                  <input type="hidden" id="vendor-id" />

                  <div class="form-group">
                    <label for="vendor-kode">Kode Vendor</label>
                    <input type="text" id="vendor-kode" required placeholder="Contoh: 19" maxlength="10" />
                  </div>

                  <div class="form-group">
                    <label for="vendor-nama">Nama Vendor</label>
                    <input type="text" id="vendor-nama" required placeholder="Nama lengkap vendor" />
                  </div>

                  <div class="form-group">
                    <label for="vendor-pic">PIC (Person In Charge)</label>
                    <input type="text" id="vendor-pic" placeholder="Nama kontak person" />
                  </div>

                  <div class="form-group">
                    <label for="vendor-nohp">No HP/Telp</label>
                    <input type="tel" id="vendor-nohp" placeholder="Contoh: 6281234567890" />
                  </div>

                  <div class="form-group">
                    <label for="vendor-alamat">Alamat</label>
                    <textarea id="vendor-alamat" rows="3" placeholder="Alamat lengkap vendor"></textarea>
                  </div>

                  <div class="form-group">
                    <button type="submit" class="btn btn-primary" id="btn-save-vendor">
                      Simpan Vendor
                    </button>
                    <button type="button" class="btn btn-secondary" id="btn-cancel-vendor" style="display: none">
                      Batal
                    </button>
                  </div>
                </form>
                <div id="vendor-notification" class="notification"></div>
              </div>

              <!-- Import Excel -->
              <div class="card">
                <h2><i class="fa-solid fa-file-excel"></i> Import dari Excel</h2>

                <!-- Download Template -->
                <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                  <p style="margin: 0 0 10px 0; font-size: 13px;">
                    <i class="fa-solid fa-info-circle"></i> <strong>Step 1:</strong> Export data ke Excel, edit di
                    Excel, lalu upload kembali
                  </p>
                  <button id="btn-download-template" class="btn btn-secondary" style="width: 100%;">
                    <i class="fa-solid fa-download"></i> Export Data Vendor ke Excel
                  </button>
                </div>

                <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                  Upload file Excel (.xlsx) dengan kolom: KODE, MASTER VENDOR, PIC, NO HP/TELP, ALAMAT
                </p>
                <div class="form-group">
                  <label for="vendor-excel-file">Pilih File Excel</label>
                  <input type="file" id="vendor-excel-file" accept=".xlsx,.xls"
                    style="padding: 10px; border: 2px dashed #ccc; border-radius: 8px; width: 100%; cursor: pointer;" />
                </div>
                <button id="btn-import-vendors" class="btn btn-primary" style="width: 100%;" disabled>
                  <i class="fa-solid fa-sync"></i> Sinkronkan Data Vendor
                </button>
                <div id="import-preview" style="margin-top: 15px; max-height: 200px; overflow-y: auto; display: none;">
                  <p><strong>Preview Data:</strong></p>
                  <table class="data-table" style="font-size: 12px;">
                    <thead id="import-preview-head"></thead>
                    <tbody id="import-preview-body"></tbody>
                  </table>
                </div>
                <div id="import-status" style="margin-top: 10px;"></div>
              </div>
            </div>

            <!-- Daftar Vendor -->
            <div class="user-list-wrapper">
              <div class="card">
                <h2>Daftar Vendor</h2>
                <div class="table-responsive">
                  <table class="data-table" id="vendor-table">
                    <thead>
                      <tr>
                        <th>Kode</th>
                        <th>Nama Vendor</th>
                        <th>PIC</th>
                        <th>No HP</th>
                        <th>Alamat</th>
                        <th>Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="vendor-table-body">
                      <tr>
                        <td colspan="6">Memuat data vendor...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="content-material" class="content-section hidden">
        <div class="content-header">
          <h1>Master Material</h1>
        </div>
        <p>Fitur ini sedang dalam pengembangan.</p>
      </section>

      <section id="content-settings" class="content-section hidden">
        <div class="content-header">
          <h1>Pengaturan</h1>
        </div>

        <div class="content-container">
          <div class="card settings-card">
            <h2>Reset Nomor Purchase Request (PR)</h2>
            <p>
              Gunakan fitur ini untuk mengatur ulang nomor urut awal PR untuk
              periode saat ini. Format: XXX/PR-SPA/HO/[Bulan Romawi]/[Tahun].
            </p>

            <form id="form-reset-pr">
              <div class="form-group">
                <label for="current-pr-reference">Nomor PR Terakhir Digunakan (Referensi)</label>
                <input type="text" id="current-pr-reference" disabled placeholder="Memuat data referensi..." />
              </div>

              <div class="form-group">
                <label for="new-pr-start-number">Setel Nomor Urut Awal (XXX) Menjadi:</label>
                <input type="number" id="new-pr-start-number" min="1" max="999" required placeholder="Contoh: 1" />
                <small>Masukkan angka awal. PR baru berikutnya akan menggunakan
                  nomor ini.</small>
              </div>

              <div class="form-group">
                <label>Pratinjau Nomor PR Berikutnya:</label>
                <div id="pr-preview"></div>
              </div>

              <button type="submit" class="btn btn-primary">
                Simpan Pengaturan
              </button>
            </form>

            <div id="settings-notification" class="notification"></div>
          </div>
        </div>
      </section>

      <!-- DATABASE MANAGEMENT SECTION -->
      <section id="content-database" class="content-section hidden">
        <div class="content-header">
          <h1><i class="fa-solid fa-database"></i> Database Management</h1>
        </div>
        <p>Kelola koneksi database, lihat tabel, dan edit data langsung.</p>

        <div class="content-container">
          <!-- Connection Status Card -->
          <div class="card" style="margin-bottom: 20px;">
            <h2><i class="fa-solid fa-plug"></i> Status Koneksi</h2>
            <div id="db-status-container">
              <div id="db-status"
                style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <div id="db-status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #ccc;">
                </div>
                <span id="db-status-text">Memeriksa koneksi...</span>
              </div>
              <div id="db-info" style="margin-top: 15px; display: none;">
                <p><strong>Host:</strong> <span id="db-host">-</span></p>
                <p><strong>Database:</strong> <span id="db-name">-</span></p>
                <p><strong>Versi MySQL:</strong> <span id="db-version">-</span></p>
              </div>
              <button id="btn-refresh-db-status" class="btn btn-secondary btn-sm" style="margin-top: 10px;">
                <i class="fa-solid fa-refresh"></i> Refresh Status
              </button>
            </div>
          </div>

          <!-- Table List -->
          <div class="card" style="margin-bottom: 20px;">
            <h2><i class="fa-solid fa-table"></i> Daftar Tabel</h2>
            <div class="table-responsive">
              <table class="data-table" id="table-list">
                <thead>
                  <tr>
                    <th>Nama Tabel</th>
                    <th>Jumlah Data</th>
                    <th>Ukuran</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="table-list-body">
                  <tr>
                    <td colspan="4">Memuat daftar tabel...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Data Viewer -->
          <div class="card" id="data-viewer-card" style="display: none;">
            <h2><i class="fa-solid fa-eye"></i> Data Viewer: <span id="current-table-name">-</span></h2>
            <div style="margin-bottom: 15px;">
              <button id="btn-close-viewer" class="btn btn-secondary btn-sm">
                <i class="fa-solid fa-times"></i> Tutup
              </button>
              <button id="btn-refresh-data" class="btn btn-primary btn-sm">
                <i class="fa-solid fa-refresh"></i> Refresh
              </button>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="data-table" id="data-table">
                <thead id="data-table-head"></thead>
                <tbody id="data-table-body"></tbody>
              </table>
            </div>
            <div id="pagination-controls" style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
              <button id="btn-prev-page" class="btn btn-secondary btn-sm" disabled>← Prev</button>
              <span id="page-info">Page 1 of 1</span>
              <button id="btn-next-page" class="btn btn-secondary btn-sm" disabled>Next →</button>
            </div>
            <div id="db-notification" class="notification" style="margin-top: 15px;"></div>
          </div>

          <!-- Backup & Restore Section (New) -->
          <div class="card">
            <h2><i class="fa-solid fa-cloud-upload-alt"></i> Migrasi & Restore Database</h2>
            <div
              style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #ffc107;">
              <strong><i class="fa-solid fa-exclamation-triangle"></i> PERHATIAN PENTING:</strong>
              <p style="margin: 5px 0;">Fitur ini akan <strong>MENIMPA/MENGGABUNGKAN</strong> data database saat ini
                dengan data dari file backup.</p>
              <ul style="margin: 5px 0 0 20px; font-size: 13px;">
                <li>Gunakan file <code>full_backup.json</code> yang dihasilkan dari script export.</li>
                <li>Proses ini tidak bisa dibatalkan.</li>
                <li>Hanya tabel: Users, Vendors, Purchase Requests, PR Items yang akan diproses.</li>
              </ul>
            </div>

            <div class="form-group">
              <label>Upload File Backup (JSON)</label>
              <input type="file" id="db-backup-file" accept=".json" class="form-control"
                style="padding: 10px; border: 2px dashed #bdc3c7; width: 100%;">
            </div>

            <button id="btn-restore-db" class="btn btn-danger" style="width: 100%; margin-top: 10px;" disabled>
              <i class="fa-solid fa-upload"></i> Restore Database dari JSON
            </button>
            <div id="restore-status" style="margin-top: 10px; font-weight: bold;"></div>
          </div>

          <!-- Config Section -->
          <div class="card">
            <h2><i class="fa-solid fa-cog"></i> Konfigurasi Database</h2>
            <p>Konfigurasi koneksi database saat ini (read-only untuk keamanan).</p>
            <form id="form-db-config">
              <div class="form-group">
                <label>Host</label>
                <input type="text" id="config-host" disabled placeholder="localhost">
              </div>
              <div class="form-group">
                <label>Port</label>
                <input type="text" id="config-port" disabled placeholder="3306">
              </div>
              <div class="form-group">
                <label>User</label>
                <input type="text" id="config-user" disabled placeholder="root">
              </div>
              <div class="form-group">
                <label>Database</label>
                <input type="text" id="config-database" disabled placeholder="sistem_purchasing">
              </div>
              <div class="form-group">
                <label>Password Status</label>
                <input type="text" id="config-password-status" disabled placeholder="-">
              </div>
            </form>
            <p style="color: #666; font-size: 12px; margin-top: 10px;">
              <i class="fa-solid fa-info-circle"></i> Untuk mengubah konfigurasi database, edit file <code>.env</code>
              atau variabel environment di Railway.
            </p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="password-modal" class="modal"
    style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content card"
      style="background-color: #fefefe; margin: 10vh auto; padding: 25px; border: 1px solid #e0e0e0; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
      <span class="close-button"
        style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; line-height: 1; margin-top: -15px;">&times;</span>
      <h2>Ubah Password User</h2>
      <form id="form-edit-password">
        <input type="hidden" id="edit-password-user-id">
        <p>Mengubah password untuk user: <strong id="edit-password-username-display"></strong></p>
        <div class="form-group">
          <label for="new-password">Password Baru</label>
          <input type="password" id="new-password" required>
        </div>
        <div class="form-group">
          <label for="confirm-password">Konfirmasi Password</label>
          <input type="password" id="confirm-password" required>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">Simpan Password</button>
      </form>
      <div id="password-notification" class="notification" style="margin-top: 15px;"></div>
    </div>
  </div>

  <script src="/js/xlsx.full.min.js"></script>
  <script src="/js/pwa.js?v=1.0.2"></script>
  <script src="/js/admin.js?v=1.0.2"></script>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/sw.js")
          .then((registration) => {
            console.log("Service Worker registered:", registration);
          })
          .catch((error) => {
            console.log("Service Worker registration failed:", error);
          });
      });
    }
  </script>
</body>

</html>