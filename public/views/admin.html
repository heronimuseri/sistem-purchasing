<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Purchasing System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <!-- Include admin.css but we might need to override some styles or rely on style.css -->
  <link rel="stylesheet" href="/assets/css/admin.css">
  <link rel="manifest" href="/manifest.json">
  <style>
    /* Overrides for Admin to fit App Shell */
    .admin-container {
      display: block;
      /* Disable old flex grid */
      height: auto;
    }

    .sidebar {
      /* Hide old sidebar styles if colliding, but we need new sidebar */
      /* Actually admin.css defines .sidebar. My style.css also defines .sidebar. 
             style.css is loaded first? No, style.css loaded before admin.css.
             I should insure App Shell sidebar uses specific classes or I rely on style.css wins.
             The admin.css sidebar might conflict. 
             Let's override admin.css sidebar rules by being specific or removing admin.css reference if possible.
             However, admin.js relies on admin.css classes? Probably not JS.
             But admin.css has styles for .user-layout, .card, etc. 
             I will try to use style.css for layout and admin.css for specific admin components.
             I'll style the tabs manually here.
          */
    }

    .main-content {
      margin-left: 0;
      /* Override admin.css */
      padding: 0;
      height: auto;
      overflow: visible;
    }

    /* Tabs Navigation */
    .admin-tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 1.5rem;
      overflow-x: auto;
    }

    .admin-tab-item {
      padding: 1rem 1.5rem;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      white-space: nowrap;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .admin-tab-item:hover {
      color: var(--primary-color);
      background-color: var(--bg-color);
    }

    .admin-tab-item.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    /* Fix Content Sections */
    .content-section {
      padding: 0;
      /* Remove padding as page-content handle it */
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <i class="fa-solid fa-cubes" style="margin-right: 0.5rem;"></i> Purchasing
      </div>

      <nav class="sidebar-nav">
        <a href="/dashboard.html" class="nav-item">
          <div class="nav-icon"><i class="fa-solid fa-gauge-high"></i></div>
          <span>Dashboard</span>
        </a>

        <div class="nav-section">Purchasing</div>

        <a href="/pr.html" class="nav-item">
          <div class="nav-icon"><i class="fa-solid fa-file-pen"></i></div>
          <span>Buat PR Baru</span>
        </a>

        <a href="/daftarpr.html" class="nav-item">
          <div class="nav-icon"><i class="fa-solid fa-list-check"></i></div>
          <span>Daftar PR</span>
          <span id="dashboard-badge" class="badge badge-warning" style="margin-left: auto; display: none;">0</span>
        </a>

        <a href="/po.html" class="nav-item">
          <div class="nav-icon"><i class="fa-solid fa-file-invoice"></i></div>
          <span>Buat PO Baru</span>
        </a>

        <a href="/daftarpo.html" class="nav-item">
          <div class="nav-icon"><i class="fa-solid fa-clipboard-list"></i></div>
          <span>Daftar PO</span>
          <span id="po-badge" class="badge badge-warning" style="margin-left: auto; display: none;">0</span>
        </a>

        <div class="nav-section">Finance</div>

        <a href="/buat_tagihan.html" class="nav-item">
          <div class="nav-icon"><i class="fa-solid fa-credit-card"></i></div>
          <span>Buat Payment</span>
        </a>

        <a href="/daftar_tagihan.html" class="nav-item">
          <div class="nav-icon"><i class="fa-solid fa-money-check-dollar"></i></div>
          <span>Daftar Payment</span>
          <span id="invoice-badge" class="badge badge-warning" style="margin-left: auto; display: none;">0</span>
        </a>

        <!-- Admin Section -->
        <div id="admin-menu-section" class="hidden">
          <div class="nav-section">Administrasi</div>
          <a href="/laporanpr.html" class="nav-item">
            <div class="nav-icon"><i class="fa-solid fa-file-excel"></i></div>
            <span>Laporan PR</span>
          </a>
          <a href="/admin.html" class="nav-item active">
            <div class="nav-icon"><i class="fa-solid fa-users-gear"></i></div>
            <span>Manajemen User</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="topbar">
        <button id="sidebar-toggle" class="btn btn-secondary btn-sm" style="border: none; background: transparent;">
          <i class="fa-solid fa-bars fa-lg"></i>
        </button>

        <div class="flex items-center gap-4">
          <div id="user-info" class="font-bold text-sm"></div>
          <button id="logout-btn" class="btn btn-danger btn-sm">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
          </button>
        </div>
      </header>

      <div class="page-content">
        <div class="flex justify-between items-center mb-6" style="margin-bottom: 2rem;">
          <div>
            <h2 style="font-weight: 600; color: var(--text-primary); margin: 0;">Admin Panel</h2>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">Kelola user, vendor, dan
              konfigurasi sistem</p>
          </div>
        </div>

        <!-- Admin Tabs -->
        <div class="admin-tabs">
          <a href="#" class="nav-link admin-tab-item active" data-target="content-user">
            <i class="fa-solid fa-users-gear"></i> User
          </a>
          <a href="#" class="nav-link admin-tab-item" data-target="content-vendor">
            <i class="fa-solid fa-store"></i> Vendor
          </a>
          <a href="#" class="nav-link admin-tab-item" data-target="content-material">
            <i class="fa-solid fa-boxes-stacked"></i> Material
          </a>
          <a href="#" class="nav-link admin-tab-item" data-target="content-database">
            <i class="fa-solid fa-database"></i> Database
          </a>
          <a href="#" class="nav-link admin-tab-item" data-target="content-settings">
            <i class="fa-solid fa-gears"></i> Pengaturan
          </a>
        </div>

        <!-- Content Sections -->
        <div id="admin-content-area">

          <!-- Default / Main (Hidden or used as landing) -->
          <section id="content-main" class="content-section hidden">
            <h3>Pilih menu di atas untuk mengelola data.</h3>
          </section>

          <!-- User Management -->
          <section id="content-user" class="content-section">
            <div class="user-layout"
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem;">
              <div class="user-form-wrapper">
                <div class="card">
                  <h2 id="user-form-title" style="margin-top: 0;">Tambah User Baru</h2>
                  <form id="form-user">
                    <input type="hidden" id="user-id" />
                    <input type="hidden" id="user-company-hidden" />

                    <div class="form-group">
                      <label class="form-label" for="user-name">Nama Lengkap</label>
                      <input type="text" id="user-name" class="form-input" required placeholder="Masukkan nama user" />
                    </div>

                    <div class="form-group">
                      <label class="form-label" for="user-company">Perusahaan (Company ID)</label>
                      <select id="user-company" class="form-input" required>
                        <option value="">Pilih Perusahaan</option>
                        <option value="SPA_70">SPA_70</option>
                        <option value="SNA_70">SNA_70</option>
                        <option value="PT SPA">PT SPA</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label" for="user-username">Username</label>
                      <input type="text" id="user-username" class="form-input" required
                        placeholder="Masukkan username user" />
                    </div>

                    <div class="form-group">
                      <label class="form-label" for="user-password">Password</label>
                      <input type="password" id="user-password" class="form-input" required
                        placeholder="Isi jika tambah baru" />
                      <small class="text-muted">Wajib diisi saat Tambah User. Untuk Edit, gunakan tombol 'Pass'.</small>
                    </div>

                    <div class="form-group">
                      <label class="form-label" for="user-role">Role Approval</label>
                      <select id="user-role" class="form-input" required>
                        <option value="">Pilih Role</option>
                        <option value="kerani">kerani</option>
                        <option value="ktu">ktu</option>
                        <option value="manager">manager</option>
                        <option value="purchasing">purchasing</option>
                        <option value="manager_ho">manager_ho</option>
                        <option value="direktur">direktur</option>
                        <option value="admin">admin</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label class="form-label" for="user-wa">Nomor WhatsApp</label>
                      <input type="tel" id="user-wa" class="form-input" required placeholder="Contoh: 6281234567890" />
                      <small class="text-muted">Format: 628xxx (tanpa + atau 0 depan).</small>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                      <button type="submit" class="btn btn-primary" id="btn-save-user">Simpan User</button>
                      <button type="button" class="btn btn-secondary" id="btn-cancel-edit"
                        style="display: none">Batal</button>
                    </div>
                  </form>
                  <div id="user-notification" class="notification" style="display: none;"></div>
                </div>

                <!-- Group WA Config -->
                <div class="card" style="margin-top: 1.5rem;">
                  <h2 style="margin-top: 0; font-size: 1.1rem;">Konfigurasi Grup WA Posting</h2>
                  <p class="text-muted" style="font-size: 0.9rem;">ID Grup WA untuk notifikasi approval final.</p>
                  <form id="form-group-wa">
                    <div class="form-group">
                      <label class="form-label" for="group-wa-id">ID/Nomor Grup WA</label>
                      <input type="text" id="group-wa-id" class="form-input" required
                        placeholder="Masukkan ID Grup WA" />
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                      <button type="submit" class="btn btn-primary">Simpan Konfigurasi</button>
                    </div>
                  </form>
                  <div id="group-wa-notification" class="notification" style="display: none;"></div>
                </div>

                <!-- Notification Toggle -->
                <div class="card" style="margin-top: 1.5rem;">
                  <h2 style="margin-top: 0; font-size: 1.1rem;">Pengaturan Notifikasi</h2>
                  <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 1rem;">
                    <label class="switch">
                      <input type="checkbox" id="toggle-wa-notifications">
                      <span class="slider round"></span>
                    </label>
                    <span id="wa-notification-status-text" style="font-weight: 500;">Notifikasi Aktif</span>
                  </div>
                </div>
              </div>

              <div class="user-list-wrapper">
                <div class="card">
                  <h2 style="margin-top: 0;">Daftar User</h2>
                  <div class="table-container">
                    <table class="data-table w-full">
                      <thead>
                        <tr>
                          <th>Nama</th>
                          <th>Perusahaan</th>
                          <th>Username</th>
                          <th>Role</th>
                          <th>Nomor WA</th>
                          <th>Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="user-table-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Vendor Management -->
          <section id="content-vendor" class="content-section hidden">
            <div class="user-layout"
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem;">
              <!-- Form Vendor -->
              <div class="user-form-wrapper">
                <div class="card">
                  <h2 id="vendor-form-title" style="margin-top: 0;">Tambah Vendor Baru</h2>
                  <form id="form-vendor">
                    <input type="hidden" id="vendor-id" />
                    <div class="form-group">
                      <label class="form-label" for="vendor-kode">Kode Vendor</label>
                      <input type="text" id="vendor-kode" class="form-input" required placeholder="Contoh: 19"
                        maxlength="10" />
                    </div>
                    <div class="form-group">
                      <label class="form-label" for="vendor-nama">Nama Vendor</label>
                      <input type="text" id="vendor-nama" class="form-input" required
                        placeholder="Nama lengkap vendor" />
                    </div>
                    <div class="form-group">
                      <label class="form-label" for="vendor-pic">PIC</label>
                      <input type="text" id="vendor-pic" class="form-input" placeholder="Nama kontak person" />
                    </div>
                    <div class="form-group">
                      <label class="form-label" for="vendor-nohp">No HP/Telp</label>
                      <input type="tel" id="vendor-nohp" class="form-input" placeholder="Contoh: 6281234567890" />
                    </div>
                    <div class="form-group">
                      <label class="form-label" for="vendor-alamat">Alamat</label>
                      <textarea id="vendor-alamat" class="form-input" rows="3" placeholder="Alamat lengkap"></textarea>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                      <button type="submit" class="btn btn-primary" id="btn-save-vendor">Simpan Vendor</button>
                      <button type="button" class="btn btn-secondary" id="btn-cancel-vendor"
                        style="display: none">Batal</button>
                    </div>
                  </form>
                  <div id="vendor-notification" class="notification" style="display: none;"></div>
                </div>

                <!-- Import Excel -->
                <div class="card" style="margin-top: 1.5rem;">
                  <h2 style="margin-top: 0; font-size: 1.1rem;"><i class="fa-solid fa-file-excel"></i> Import dari Excel
                  </h2>
                  <div
                    style="background: #e8f5e9; padding: 12px; border-radius: var(--radius-sm); margin-bottom: 15px; border: 1px solid #c8e6c9;">
                    <p style="margin: 0 0 10px 0; font-size: 13px; color: #2e7d32;">
                      <i class="fa-solid fa-info-circle"></i> <strong>Step 1:</strong> Export template, edit, lalu
                      upload.
                    </p>
                    <button id="btn-download-template" class="btn btn-secondary btn-sm" style="width: 100%;">
                      <i class="fa-solid fa-download"></i> Download Template
                    </button>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Upload File Excel (.xlsx)</label>
                    <input type="file" id="vendor-excel-file" accept=".xlsx,.xls" class="form-input"
                      style="padding: 10px;" />
                  </div>
                  <button id="btn-import-vendors" class="btn btn-primary" style="width: 100%; margin-top: 1rem;"
                    disabled>
                    <i class="fa-solid fa-sync"></i> Sinkronkan
                  </button>
                  <div id="import-preview"
                    style="margin-top: 15px; max-height: 200px; overflow-y: auto; display: none;">
                    <table class="data-table" style="font-size: 12px;">
                      <thead id="import-preview-head"></thead>
                      <tbody id="import-preview-body"></tbody>
                    </table>
                  </div>
                  <div id="import-status" style="margin-top: 10px;"></div>
                </div>
              </div>

              <!-- List Vendor -->
              <div class="user-list-wrapper">
                <div class="card">
                  <h2 style="margin-top: 0;">Daftar Vendor</h2>
                  <div class="table-container">
                    <table class="data-table w-full" id="vendor-table">
                      <thead>
                        <tr>
                          <th>Kode</th>
                          <th>Nama Vendor</th>
                          <th>PIC</th>
                          <th>No HP</th>
                          <th>Alamat</th>
                          <th>Aksi</th>
                        </tr>
                      </thead>
                      <tbody id="vendor-table-body">
                        <tr>
                          <td colspan="6">Memuat data vendor...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Material -->
          <section id="content-material" class="content-section hidden">
            <div class="card">
              <h2>Master Material</h2>
              <p>Fitur ini sedang dalam pengembangan.</p>
            </div>
          </section>

          <!-- Database -->
          <section id="content-database" class="content-section hidden">
            <div class="card" style="margin-bottom: 2rem;">
              <h2 style="margin-top: 0;">Status Koneksi Database</h2>
              <div id="db-status-container"
                style="display: flex; align-items: center; gap: 1rem; background: #f8fafc; padding: 1rem; border-radius: var(--radius-md);">
                <div id="db-status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #ccc;">
                </div>
                <span id="db-status-text">Memeriksa koneksi...</span>
                <button id="btn-refresh-db-status" class="btn btn-secondary btn-sm" style="margin-left: auto;">
                  <i class="fa-solid fa-refresh"></i> Refresh
                </button>
              </div>
              <div id="db-info" style="margin-top: 1rem; display: none; font-family: monospace;">
                <p><strong>Host:</strong> <span id="db-host">-</span></p>
                <p><strong>Database:</strong> <span id="db-name">-</span></p>
                <p><strong>Version:</strong> <span id="db-version">-</span></p>
              </div>
            </div>

            <div class="card" style="margin-bottom: 2rem;">
              <h2 style="margin-top: 0;">Daftar Tabel</h2>
              <div class="table-container">
                <table class="data-table w-full" id="table-list">
                  <thead>
                    <tr>
                      <th>Nama Tabel</th>
                      <th>Jumlah Data</th>
                      <th>Ukuran</th>
                      <th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="table-list-body">
                    <tr>
                      <td colspan="4">Memuat daftar tabel...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Data Viewer -->
            <div class="card" id="data-viewer-card" style="display: none; margin-bottom: 2rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <h2 style="margin: 0;">Data Viewer: <span id="current-table-name">-</span></h2>
                <div style="display: flex; gap: 0.5rem;">
                  <button id="btn-refresh-data" class="btn btn-primary btn-sm"><i
                      class="fa-solid fa-refresh"></i></button>
                  <button id="btn-close-viewer" class="btn btn-secondary btn-sm"><i
                      class="fa-solid fa-times"></i></button>
                </div>
              </div>
              <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table w-full" id="data-table">
                  <thead id="data-table-head"></thead>
                  <tbody id="data-table-body"></tbody>
                </table>
              </div>
              <div style="margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center; justify-content: center;">
                <button id="btn-prev-page" class="btn btn-secondary btn-sm" disabled>Prev</button>
                <span id="page-info">Page 1 of 1</span>
                <button id="btn-next-page" class="btn btn-secondary btn-sm" disabled>Next</button>
              </div>
            </div>

            <!-- Backup Restore -->
            <div class="card">
              <h2 style="margin-top: 0; color: var(--danger-color);"><i class="fa-solid fa-cloud-upload-alt"></i>
                Migrasi & Restore</h2>
              <div
                style="background: #fff3cd; padding: 1rem; border-radius: var(--radius-sm); border-left: 5px solid #ffc107; margin-bottom: 1rem;">
                <strong>PERHATIAN:</strong> Fitur ini akan menimpa data. Gunakan file <code>full_backup.json</code>.
              </div>
              <div class="form-group">
                <label class="form-label">Upload File Backup (JSON)</label>
                <input type="file" id="db-backup-file" accept=".json" class="form-input" />
              </div>
              <button id="btn-restore-db" class="btn btn-danger" style="width: 100%; margin-top: 1rem;" disabled>
                <i class="fa-solid fa-upload"></i> Restore Database
              </button>
              <div id="restore-status" style="margin-top: 10px; font-weight: bold;"></div>
            </div>
          </section>

          <!-- Settings -->
          <section id="content-settings" class="content-section hidden">
            <div class="card">
              <h2 style="margin-top: 0;">Reset Nomor Purchase Request (PR)</h2>
              <p class="text-secondary">Reset nomor urut awal PR untuk periode baru.</p>

              <form id="form-reset-pr" style="margin-top: 1.5rem;">
                <div class="form-group">
                  <label class="form-label">Nomor PR Terakhir (Ref)</label>
                  <input type="text" id="current-pr-reference" class="form-input" disabled />
                </div>
                <div class="form-group">
                  <label class="form-label">Setel Nomor Awal Baru (1-999)</label>
                  <input type="number" id="new-pr-start-number" class="form-input" min="1" max="999" required />
                </div>
                <div class="form-group">
                  <label class="form-label">Pratinjau:</label>
                  <div id="pr-preview" style="font-family: monospace; font-weight: bold; color: var(--primary-color);">
                  </div>
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Simpan Pengaturan</button>
              </form>
            </div>
          </section>

        </div>
      </div>
    </main>
  </div>

  <!-- Password Modal -->
  <div id="password-modal" class="modal"
    style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content card"
      style="background-color: #fefefe; margin: 10vh auto; padding: 1.5rem; max-width: 400px; border-radius: var(--radius-md);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0; font-size: 1.25rem;">Ubah Password</h2>
        <span class="close-button" style="font-size: 1.5rem; cursor: pointer;">&times;</span>
      </div>
      <form id="form-edit-password">
        <input type="hidden" id="edit-password-user-id">
        <p style="margin-bottom: 1rem;">User: <strong id="edit-password-username-display"></strong></p>
        <div class="form-group">
          <label class="form-label" for="new-password">Password Baru</label>
          <input type="password" id="new-password" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="confirm-password">Konfirmasi Password</label>
          <input type="password" id="confirm-password" class="form-input" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Simpan Password</button>
      </form>
      <div id="password-notification" class="notification" style="margin-top: 1rem; display: none;"></div>
    </div>
  </div>

  <script src="/assets/js/xlsx.full.min.js"></script>
  <script src="/assets/js/pwa.js"></script>
  <script src="/assets/js/app.js"></script>
  <script src="/assets/js/admin.js"></script>
</body>

</html>